---
steps:
  - powershell: Write-Host "##vso[task.setvariable variable=HOME;]D:\"
    continueOnError: true
    condition: eq(variables['AGENT.OS'], 'Windows_NT')
    displayName: "Make sure $HOME is same is Agent.BuildDirectory"
  - bash: |
      # COMPUTE THE ESY INSTALL CACHE LOCATION AHEAD OF TIME
      DESIRED_LEN="85"
      # Not sure why, windows is has one extra underscore. Observed at https://github.com/ManasJayanth/reason-ocaml-tls-tutorial-meet/commit/3b4a6113cc413cc5cdf0fd8a2521c4c44dd1c0e5
      if [ "$AGENT_OS" == "Windows_NT" ]; then
        DESIRED_LEN="86"
      fi
      HOME_ESY3="$HOME/.esy/3"
      HOME_ESY3_LEN=${#HOME_ESY3}
      NUM_UNDERS=$(echo "$(($DESIRED_LEN-$HOME_ESY3_LEN))")
      UNDERS=$(printf "%-${NUM_UNDERS}s" "_")
      UNDERS="${UNDERS// /_}"
      THE_ESY__CACHE_INSTALL_PATH=${HOME_ESY3}${UNDERS}/i
      if [ "$AGENT_OS" == "Windows_NT" ]; then
        THE_ESY__CACHE_INSTALL_PATH=$( cygpath --mixed --absolute "$THE_ESY__CACHE_INSTALL_PATH")
      fi
      echo "THE_ESY__CACHE_INSTALL_PATH: $THE_ESY__CACHE_INSTALL_PATH"
      # This will be exposed as an env var ESY__CACHE_INSTALL_PATH, or an
      # Azure var esy__cache_install_path
      echo "##vso[task.setvariable variable=esy__cache_install_path]$THE_ESY__CACHE_INSTALL_PATH"

  - bash: env
    displayName: "Print environment"

  - task: Cache@2
    inputs:
      key: 'v1 | esy-install-cache | "$(Agent.OS)" | "$(Build.SourcesDirectory)/esy.lock/index.json"' # vPrimary, here, is just a way to bust cache during debugging. Inspired from https://docs.microsoft.com/en-us/azure/devops/pipelines/caching/?view=azure-devops#can-i-clear-a-cache" 
      restoreKeys: |
        v1 | esy-install-cache | ${{ parameters.platform }}
      path: $(ESY__CACHE_INSTALL_PATH)
      cacheHitVar: ESY_INSTALL_CACHE_RESTORED
    displayName:  "Caching $(ESY__CACHE_INSTALL_PATH)"
  - task: Cache@2
    inputs:
      key: 'v1 | esy-sources | "$(Agent.OS)" | "$(Build.SourcesDirectory)/esy.lock/index.json"' # vPrimary, here, is just a way to bust cache during debugging. Inspired from https://docs.microsoft.com/en-us/azure/devops/pipelines/caching/?view=azure-devops#can-i-clear-a-cache" 
      restoreKeys: |
          v1 | esy-sources | "$(Agent.OS)"
          v1 | esy-sources
      path: "$(ESY__CACHE_INSTALL_PATH)/../../source"
      cacheHitVar: ESY_SOURCE_CACHE_RESTORED
    displayName:  "Caching $(ESY__CACHE_INSTALL_PATH)/../../source"
